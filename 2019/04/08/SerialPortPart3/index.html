<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我答应了十八岁的自己不会变"><title>Qt上位机开发：串口控制模块开发 | SilverBullet</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '8eae842203686feabfd7f0793e26ea52';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Qt上位机开发：串口控制模块开发</h1><a id="logo" href="/.">SilverBullet</a><p class="description">说些自己想说的话</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/tag/"><i class="fa fa-tag"> Tag</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Qt上位机开发：串口控制模块开发</h1><div class="post-meta">2019-04-08<span> | </span><span class="category"><a href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3k</span><span class="post-meta-item-text"> Words</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> Minutes</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%B2%E5%8F%A3%E8%B0%83%E8%AF%95%E7%95%8C%E9%9D%A2"><span class="toc-number">1.</span> <span class="toc-text">创建串口调试界面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%B2%E5%8F%A3"><span class="toc-number">2.</span> <span class="toc-text">配置串口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%BC%80%E4%B8%B2%E5%8F%A3"><span class="toc-number">3.</span> <span class="toc-text">打开串口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E4%B8%AD%E6%96%AD%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%85%89%E7%85%A7%E5%BC%BA%E5%BA%A6"><span class="toc-number">4.</span> <span class="toc-text">发送中断并获取当前光照强度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E7%9B%91%E6%8E%A7"><span class="toc-number">5.</span> <span class="toc-text">定时监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">6.</span> <span class="toc-text">显示数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97"><span class="toc-number">7.</span> <span class="toc-text">系统日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">8.</span> <span class="toc-text">数据存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">9.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">10.</span> <span class="toc-text">附录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="toc-number">11.</span> <span class="toc-text">源码下载</span></a></li></ol></div></div><div class="post-content"><p>这个项目是18年初寒假开始的，初始想法是利用寒假时间学习Qt开发并且顺便把毕业设计做出来，后来毕业设计做出来了，这个项目也完成了，然后又投入了二战，所以分享开发的过程的Blog却一直没有时间写，现在收到了录取通知，又想起这个事情，可能思绪不太连贯了，但我还是想把这个事情做下来。</p>
<span id="more"></span>

<h2 id="创建串口调试界面"><a href="#创建串口调试界面" class="headerlink" title="创建串口调试界面"></a>创建串口调试界面</h2><p><strong>串口调试器的主要需求：</strong></p>
<ol>
<li>显示来自串口接收到的信息；</li>
<li>向串口发送中断；</li>
<li>配置串口。</li>
</ol>
<p><strong>根据需求设计UI界面</strong></p>
<p><img src="/2019/04/08/SerialPortPart3/image1.jpg" alt="image"></p>
<p>&emsp;&emsp;其中界面的设计主要用到了<code>Qlabel</code>、<code>QTextEdit</code>、<code>QCamboBox</code>、<code>QPushButton</code>,其中较为复杂的应该是QTextEdit组件的输出格式控制。</p>
<h2 id="配置串口"><a href="#配置串口" class="headerlink" title="配置串口"></a>配置串口</h2><p>&emsp;&emsp;由于Qt5内置了串口类，所以我们可以通过直接调用类方法进行串口的配置，这真的是一件十分Nice的事情，之前我也有通过Keil开发过C51的串口模块，相比较而言真的是能省不少心。</p>
<p>&emsp;&emsp;当用户通过LogIn界面登陆进入串口界面时，此时程序已经开始查找当前可用串口，显示在端口号处。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//查找可用的串口</span></span><br><span class="line">   foreach(<span class="keyword">const</span> QSerialPortInfo &amp;info, QSerialPortInfo::<span class="built_in">availablePorts</span>())</span><br><span class="line">   &#123;</span><br><span class="line">       QSerialPort serial;</span><br><span class="line">       serial.<span class="built_in">setPort</span>(info);</span><br><span class="line">       <span class="keyword">if</span>(serial.<span class="built_in">open</span>(QIODevice::ReadWrite))</span><br><span class="line">       &#123;</span><br><span class="line">           ui-&gt;combox-&gt;<span class="built_in">addItem</span>(serial.<span class="built_in">portName</span>());</span><br><span class="line">           serial.<span class="built_in">close</span>();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//设置波特率下拉菜单默认显示第三项</span></span><br><span class="line">   ui-&gt;baudrate-&gt;<span class="built_in">setCurrentIndex</span>(<span class="number">3</span>);</span><br><span class="line">   <span class="comment">//关闭发送按钮的使能</span></span><br><span class="line"><span class="comment">//   ui-&gt;openport-&gt;setEnabled(false);</span></span><br><span class="line">   <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;界面设定成功！&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="打开串口"><a href="#打开串口" class="headerlink" title="打开串口"></a>打开串口</h2><p>&emsp;&emsp;点击<kbd>打开串口</kbd>，系统自动读取用户所设置的串口配置，这里需要注意的是虽然有校验位选项，但是我没有使用，所以直接使用了<code>serial-&gt;setParity(QSerialPort::NoParity)</code>。从逻辑上来讲，当用户以当前设置打开了串口，设置变不能再更改了，所以在点击<kbd>打开串口</kbd>后，应将<code>QCamboBox</code>关闭使能，然后将<code>QPushButton</code>的文字内容改成“关闭串口”。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">serial = <span class="keyword">new</span> QSerialPort;</span><br><span class="line">        <span class="comment">//设置串口名</span></span><br><span class="line">        serial-&gt;<span class="built_in">setPortName</span>(ui-&gt;combox-&gt;<span class="built_in">currentText</span>());</span><br><span class="line">        <span class="comment">//打开串口</span></span><br><span class="line">        serial-&gt;<span class="built_in">open</span>(QIODevice::ReadWrite);</span><br><span class="line">        serialInfo = serialInfo + <span class="string">&quot;Mode: ReadWrite&quot;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="comment">//设置波特率</span></span><br><span class="line">        serial-&gt;<span class="built_in">setBaudRate</span>(ui-&gt;baudrate-&gt;<span class="built_in">currentText</span>().<span class="built_in">toInt</span>());</span><br><span class="line">        <span class="comment">//设置数据位数</span></span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span>(ui-&gt;databit-&gt;<span class="built_in">currentIndex</span>())</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>: serial-&gt;<span class="built_in">setDataBits</span>(QSerialPort::Data5); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>: serial-&gt;<span class="built_in">setDataBits</span>(QSerialPort::Data6); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>: serial-&gt;<span class="built_in">setDataBits</span>(QSerialPort::Data7); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>: serial-&gt;<span class="built_in">setDataBits</span>(QSerialPort::Data8); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serialInfo = serialInfo + <span class="string">&quot;Data Bit: &quot;</span> + ui-&gt;databit-&gt;<span class="built_in">currentText</span>() + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="comment">//设置奇偶校验</span></span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span>(ui-&gt;conparebit-&gt;<span class="built_in">currentIndex</span>())</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: serial-&gt;<span class="built_in">setParity</span>(QSerialPort::NoParity); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serialInfo = serialInfo + <span class="string">&quot;Conpare Bit&quot;</span> + ui-&gt;conparebit-&gt;<span class="built_in">currentText</span>() + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="comment">//设置停止位</span></span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span>(ui-&gt;stopbit-&gt;<span class="built_in">currentIndex</span>())</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: serial-&gt;<span class="built_in">setStopBits</span>(QSerialPort::OneStop); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: serial-&gt;<span class="built_in">setStopBits</span>(QSerialPort::TwoStop); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serialInfo = serialInfo + <span class="string">&quot;Stop Bit&quot;</span> + ui-&gt;stopbit-&gt;<span class="built_in">currentText</span>() + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="comment">//设置流控制</span></span><br><span class="line">        serial-&gt;<span class="built_in">setFlowControl</span>(QSerialPort::NoFlowControl);</span><br><span class="line">        serialInfo = serialInfo + <span class="string">&quot;FlowControl: No flow control.&quot;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭设置菜单使能</span></span><br><span class="line">        ui-&gt;combox-&gt;<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;baudrate-&gt;<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;databit-&gt;<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;conparebit-&gt;<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;stopbit-&gt;<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;openport-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;关闭串口&quot;</span>));</span><br><span class="line">        ui-&gt;send-&gt;<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//连接信号槽</span></span><br><span class="line">        QObject::<span class="built_in">connect</span>(serial, &amp;QSerialPort::readyRead, <span class="keyword">this</span>, &amp;usr::Read_Data);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[on_openport_clicked()]: System Start.&quot;</span>);</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[on_openport_clicked()]&quot;</span> +<span class="string">&#x27;\n&#x27;</span> + serialInfo);</span><br></pre></td></tr></table></figure>



<h2 id="发送中断并获取当前光照强度"><a href="#发送中断并获取当前光照强度" class="headerlink" title="发送中断并获取当前光照强度"></a>发送中断并获取当前光照强度</h2><p>&emsp;&emsp;发送中断是获取数据的最基本的方式，获取实时数据或者定时获取数据归根结底都是基于发送中断于定时发送中断实现的。得益于Qt5串口类的封装，发送中断变得很简洁。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向单片机发送check</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr::sendchk</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QString chk = <span class="string">&quot;check&quot;</span>;</span><br><span class="line">    serial-&gt;<span class="built_in">write</span>(chk.<span class="built_in">toLatin1</span>());</span><br><span class="line">    <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[sendchk()]: CHECK has been sent.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="定时监控"><a href="#定时监控" class="headerlink" title="定时监控"></a>定时监控</h2><p>&emsp;&emsp;通过定时的向串口发送中断获取信息，来起到监控数据的功能。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr::on_startAutoControl_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(token == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;token == false&quot;</span>);</span><br><span class="line">        ui-&gt;startAutoControl-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;暂停监控&quot;</span>));</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;暂停监控&quot;</span>);</span><br><span class="line">        token = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;token赋值为true&quot;</span>);</span><br><span class="line">        <span class="built_in">on_autoControlSwitch_stateChanged</span>(Qt::Checked);</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[on_startAutoControl_clicked()]: Auto Control has been started.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(token == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;token == true&quot;</span>);</span><br><span class="line">        ui-&gt;startAutoControl-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;开始监控&quot;</span>));</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;开始监控&quot;</span>);</span><br><span class="line">        token = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;token赋值为false&quot;</span>);</span><br><span class="line">        <span class="built_in">on_autoControlSwitch_stateChanged</span>(Qt::Unchecked);</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[on_startAutoControl_clicked()]: Auto Control has been stopped.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;定时功能使用了<code>QTimer类</code>，并且通过槽函数机制链接到<code>sendchk()函数</code>给串口发送中断。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启自动监控</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr::on_autoControlSwitch_stateChanged</span><span class="params">(<span class="keyword">int</span> arg1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(arg1 == Qt::Checked)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;timer == checked&quot;</span>);       <span class="comment">//设置定时器</span></span><br><span class="line">        timer = <span class="keyword">new</span> <span class="built_in">QTimer</span>(<span class="keyword">this</span>);</span><br><span class="line">        timer-&gt;<span class="built_in">setInterval</span>(<span class="number">20000</span>);               <span class="comment">//设置时间间隔</span></span><br><span class="line">        <span class="built_in">connect</span>(timer,<span class="built_in">SIGNAL</span>(<span class="built_in">timeout</span>()),<span class="keyword">this</span>,<span class="built_in">SLOT</span>(<span class="built_in">sendchk</span>()));      <span class="comment">//链接槽函数</span></span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;Timer has been inited!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        timer-&gt;<span class="built_in">start</span>(<span class="number">1000</span>);     <span class="comment">//开始</span></span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[on_autoControlSwitch_stateChanged]: QTimer has been started.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(arg1 == Qt::Unchecked)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;arg1 == unchecked&quot;</span>);</span><br><span class="line">        timer-&gt;<span class="built_in">stop</span>();                      <span class="comment">//暂停定时器</span></span><br><span class="line">        <span class="built_in">qDebug</span>()&lt;&lt;<span class="built_in">tr</span>(<span class="string">&quot;已暂停定时器&quot;</span>);</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[on_autoControlSwitch_stateChanged]: QTimer has been paused.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="显示数据"><a href="#显示数据" class="headerlink" title="显示数据"></a>显示数据</h2><p>&emsp;&emsp;显示数据是我在开发过程中花费时间最长的模块，原因是我不太明白Qt接收到串口信息的数据类型以及如何进行格式转换。串口接收到的数据是十六进制的信息，此处需要对其进行格式转换，但是不知为何我在使用<code>toInt()方法</code>时总是有Bug，不太明白为什么，如果有大佬知道的话，请评论区解答一下，谢谢~<br>&emsp;&emsp;所以这里提供另一种解决方案。总的逻辑是这样，首先通过寄存器<code>buf</code>暂存从串口中读取到的数据，然后通过<code>bytesToInt(buf)</code>转化成整型数据，然后再通过<code>QString::number(decbuf,10)</code>将其转化成字符串型输出。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将QByteArray型转换成int型</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">usr::bytesToInt</span><span class="params">(QByteArray bytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> addr = bytes[<span class="number">0</span>] &amp; <span class="number">0x000000FF</span>;</span><br><span class="line">    addr |= ((bytes[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0x0000FF00</span>);</span><br><span class="line">    addr |= ((bytes[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) &amp; <span class="number">0x00FF0000</span>);</span><br><span class="line">    addr |= ((bytes[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>) &amp; <span class="number">0xFF000000</span>);</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取接收到的数据</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr::Read_Data</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QByteArray buf;</span><br><span class="line">    <span class="keyword">int</span> decbuf;</span><br><span class="line">    <span class="comment">//bool ok;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取串口数据</span></span><br><span class="line">    buf = serial-&gt;<span class="built_in">readAll</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对串口数据进行格式转换</span></span><br><span class="line">    decbuf = <span class="built_in">bytesToInt</span>(buf);</span><br><span class="line">    QString strbuf = QString::<span class="built_in">number</span>(decbuf,<span class="number">10</span>);</span><br><span class="line">    QString strTime = <span class="built_in">getTime</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ifHandle == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        strbuf = strTime + <span class="string">&quot;:      光照强度为：&quot;</span> + strbuf + <span class="string">&quot;**********手动获取&quot;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="built_in">writeFile</span>(strbuf);</span><br><span class="line">        ifHandle = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        strbuf = strTime + <span class="string">&quot;:      光照强度为：&quot;</span> + strbuf + <span class="string">&quot;**********自动获取&quot;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        <span class="built_in">writeFile</span>(strbuf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!buf.<span class="built_in">isEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        QString str = ui-&gt;outputEdit-&gt;<span class="built_in">toPlainText</span>();</span><br><span class="line"></span><br><span class="line">        str+=strbuf + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        ui-&gt;outputEdit-&gt;<span class="built_in">clear</span>();</span><br><span class="line">        ui-&gt;outputEdit-&gt;<span class="built_in">append</span>(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buf.<span class="built_in">clear</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="系统日志"><a href="#系统日志" class="headerlink" title="系统日志"></a>系统日志</h2><p>&emsp;&emsp;这个模块不是必要模块，有没有都不影响程序运行，只是在开发过程调试Bug中大量使用了<code>qDebug()</code>打印运行信息，最后索性将其封装成一个单独的方法，用来保存运行信息，当系统宕机时，可以查看系统日志了解系统在哪个模块出现了问题。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//系统日志</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr::log</span><span class="params">(QString str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QFile <span class="title">file</span><span class="params">(<span class="string">&quot;log.csv&quot;</span>)</span></span>;</span><br><span class="line">    QString strTime = <span class="built_in">getTime</span>();</span><br><span class="line"></span><br><span class="line">    str = <span class="string">&#x27;\n&#x27;</span> + strTime + <span class="string">&quot;:  &quot;</span> + str;</span><br><span class="line"></span><br><span class="line">    file.<span class="built_in">open</span>(QIODevice::ReadWrite | QIODevice::Append);</span><br><span class="line"></span><br><span class="line">    <span class="function">QTextStream <span class="title">out</span><span class="params">(&amp;file)</span></span>;</span><br><span class="line">    out&lt;&lt;str&lt;&lt;endl;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;write success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2><p>&emsp;&emsp;数据存储讲道理是应该架在数据库上的，但是我为了图方便没有使用使用数据库，只做了一张表格存储数据。说到这，上个月我去参加山大的研究生复试，面试的时候介绍我的项目，因为这个还被老师质疑了。</p>
<blockquote>
<p>我：………………（介绍我的项目）……老师，我介绍完了。<br>老师：就这个？<br>我：？？？<br>我：就这个…<br>老师：你用了什么数据库？<br>我：没用数据库…<br>老师：没用数据库？<br>我：对。<br>老师：行，就这样吧。</p>
</blockquote>
<p>&emsp;&emsp;所以说这东西还有很多东西需要继续做，如果大家有兴趣可以继续做下去。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//写文件模块</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr::writeFile</span><span class="params">(QString str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QFile <span class="title">file</span><span class="params">(<span class="string">&quot;data.csv&quot;</span>)</span></span>;</span><br><span class="line">    QDir dir;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;dir.<span class="built_in">currentPath</span>();</span><br><span class="line"></span><br><span class="line">    file.<span class="built_in">open</span>(QIODevice::ReadWrite | QIODevice::Append);</span><br><span class="line"></span><br><span class="line">    <span class="function">QTextStream <span class="title">out</span><span class="params">(&amp;file)</span></span>;</span><br><span class="line">    out&lt;&lt;str&lt;&lt;endl;</span><br><span class="line">    <span class="built_in">qDebug</span>()&lt;&lt;<span class="string">&quot;write success&quot;</span>;</span><br><span class="line">    <span class="built_in">log</span>(<span class="string">&quot;[usr.cpp]-[writeFile(QString str)]： write success&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;这个项目本身难度不算太高，跟着这三篇Blog自己单独的做下来我认为问题不大，但这恰恰失去了Debug本身的乐趣，我至今还记得解决每一个问题时的喜悦心情，那种欢愉是copy难以企及的。<br>&emsp;&emsp;我认为程序猿最重要的学习方式就是在Coding过程中你所收获的新的解题思路以及欢愉。</p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>单片机代码<br><code>main.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;led.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;delay.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;key.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;lcd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;usart.h&quot;</span>	 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;adc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">extern</span> u8 send_flag;</span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;	 </span><br><span class="line">   	u16 adcx;</span><br><span class="line">	<span class="keyword">float</span> temp;</span><br><span class="line">	delay_init();	    	 <span class="comment">//延时函数初始化	  </span></span><br><span class="line">	NVIC_Configuration(); 	 <span class="comment">//设置NVIC中断分组2:2位抢占优先级，2位响应优先级</span></span><br><span class="line">	uart_init(<span class="number">9600</span>);	 	<span class="comment">//串口初始化为9600</span></span><br><span class="line"> 	LED_Init();			     <span class="comment">//LED端口初始化 	</span></span><br><span class="line"> 	Adc_Init();		  		<span class="comment">//ADC初始化</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(send_flag == <span class="number">1</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			send_flag = <span class="number">0</span>;</span><br><span class="line">			adcx=Get_Adc_Average(ADC_Channel_1,<span class="number">10</span>);</span><br><span class="line">			USART_SendData(USART1,adcx);</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>usart.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sys.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;usart.h&quot;</span>	  </span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////// 	 </span></span><br><span class="line"><span class="comment">//如果使用ucos,则包括下面的头文件即可.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SYSTEM_SUPPORT_UCOS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;includes.h&quot;</span>					<span class="comment">//ucos 使用	  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">u8 send_flag = <span class="number">0</span>;</span><br><span class="line">u8 rev_c_flag = <span class="number">0</span>;</span><br><span class="line">u8 rev_h_flag = <span class="number">0</span>;</span><br><span class="line">u8 rev_e_flag = <span class="number">0</span>;</span><br><span class="line">u8 rev_c2_flag = <span class="number">0</span>;</span><br><span class="line">u8 rev_k_flag = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> import(__use_no_semihosting)             </span></span><br><span class="line"><span class="comment">//标准库需要的支持函数                 </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">FILE</span> </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">	<span class="keyword">int</span> handle; </span><br><span class="line"></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line">FILE __stdout;       </span><br><span class="line"><span class="comment">//定义_sys_exit()以避免使用半主机模式    </span></span><br><span class="line">_sys_exit(<span class="keyword">int</span> x) </span><br><span class="line">&#123; </span><br><span class="line">	x = x; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//重定义fputc函数 </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fputc</span><span class="params">(<span class="keyword">int</span> ch, FILE *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;      </span><br><span class="line">	<span class="keyword">while</span>((USART1-&gt;SR&amp;<span class="number">0X40</span>)==<span class="number">0</span>);<span class="comment">//循环发送,直到发送完毕   </span></span><br><span class="line">    USART1-&gt;DR = (u8) ch;      </span><br><span class="line">	<span class="keyword">return</span> ch;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> EN_USART1_RX   <span class="comment">//如果使能了接收</span></span></span><br><span class="line"><span class="comment">//串口1中断服务程序</span></span><br><span class="line"><span class="comment">//注意,读取USARTx-&gt;SR能避免莫名其妙的错误   	</span></span><br><span class="line">u8 USART_RX_BUF[USART_REC_LEN];     <span class="comment">//接收缓冲,最大USART_REC_LEN个字节.</span></span><br><span class="line"><span class="comment">//接收状态</span></span><br><span class="line"><span class="comment">//bit15，	接收完成标志</span></span><br><span class="line"><span class="comment">//bit14，	接收到0x0d</span></span><br><span class="line"><span class="comment">//bit13~0，	接收到的有效字节数目</span></span><br><span class="line">u16 USART_RX_STA=<span class="number">0</span>;       <span class="comment">//接收状态标记	  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化IO 串口1 </span></span><br><span class="line"><span class="comment">//bound:波特率</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uart_init</span><span class="params">(u32 bound)</span></span>&#123;</span><br><span class="line">    <span class="comment">//GPIO端口设置</span></span><br><span class="line">    GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">	USART_InitTypeDef USART_InitStructure;</span><br><span class="line">	NVIC_InitTypeDef NVIC_InitStructure;</span><br><span class="line">	 </span><br><span class="line">	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1|RCC_APB2Periph_GPIOA, ENABLE);	<span class="comment">//使能USART1，GPIOA时钟</span></span><br><span class="line"> 	USART_DeInit(USART1);  <span class="comment">//复位串口1</span></span><br><span class="line">	 <span class="comment">//USART1_TX   PA.9</span></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9; <span class="comment">//PA.9</span></span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;	<span class="comment">//复用推挽输出</span></span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStructure); <span class="comment">//初始化PA9</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment">//USART1_RX	  PA.10</span></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;</span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;<span class="comment">//浮空输入</span></span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStructure);  <span class="comment">//初始化PA10</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//Usart1 NVIC 配置</span></span><br><span class="line"></span><br><span class="line">    NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;</span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=<span class="number">3</span> ;<span class="comment">//抢占优先级3</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelSubPriority = <span class="number">3</span>;		<span class="comment">//子优先级3</span></span><br><span class="line">	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;			<span class="comment">//IRQ通道使能</span></span><br><span class="line">	NVIC_Init(&amp;NVIC_InitStructure);	<span class="comment">//根据指定的参数初始化VIC寄存器</span></span><br><span class="line">  </span><br><span class="line">   <span class="comment">//USART 初始化设置</span></span><br><span class="line"></span><br><span class="line">	USART_InitStructure.USART_BaudRate = bound;<span class="comment">//一般设置为9600;</span></span><br><span class="line">	USART_InitStructure.USART_WordLength = USART_WordLength_8b;<span class="comment">//字长为8位数据格式</span></span><br><span class="line">	USART_InitStructure.USART_StopBits = USART_StopBits_1;<span class="comment">//一个停止位</span></span><br><span class="line">	USART_InitStructure.USART_Parity = USART_Parity_No;<span class="comment">//无奇偶校验位</span></span><br><span class="line">	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;<span class="comment">//无硬件数据流控制</span></span><br><span class="line">	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	<span class="comment">//收发模式</span></span><br><span class="line"></span><br><span class="line">    USART_Init(USART1, &amp;USART_InitStructure); <span class="comment">//初始化串口</span></span><br><span class="line">    USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);<span class="comment">//开启中断</span></span><br><span class="line">    USART_Cmd(USART1, ENABLE);                    <span class="comment">//使能串口 </span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART1_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span>                	<span class="comment">//串口1中断服务程序</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	u8 Res;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OS_TICKS_PER_SEC	 	<span class="comment">//如果时钟节拍数定义了,说明要使用ucosII了.</span></span></span><br><span class="line">	OSIntEnter();    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span>(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)  <span class="comment">//接收中断(接收到的数据必须是0x0d 0x0a结尾)</span></span><br><span class="line">		&#123;</span><br><span class="line">		Res =USART_ReceiveData(USART1);<span class="comment">//(USART1-&gt;DR);	//读取接收到的数据</span></span><br><span class="line">		<span class="keyword">if</span>((rev_c_flag == <span class="number">0</span>)&amp;&amp;(rev_h_flag == <span class="number">0</span>)&amp;&amp;(rev_e_flag == <span class="number">0</span>)&amp;&amp;(rev_c2_flag == <span class="number">0</span>)&amp;&amp;(rev_k_flag == <span class="number">0</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Res == <span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				rev_c_flag = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((rev_c_flag == <span class="number">1</span>)&amp;&amp;(rev_h_flag == <span class="number">0</span>)&amp;&amp;(rev_e_flag == <span class="number">0</span>)&amp;&amp;(rev_c2_flag == <span class="number">0</span>)&amp;&amp;(rev_k_flag == <span class="number">0</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Res == <span class="string">&#x27;h&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				rev_h_flag = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((rev_c_flag == <span class="number">1</span>)&amp;&amp;(rev_h_flag == <span class="number">1</span>)&amp;&amp;(rev_e_flag == <span class="number">0</span>)&amp;&amp;(rev_c2_flag == <span class="number">0</span>)&amp;&amp;(rev_k_flag == <span class="number">0</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Res == <span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				rev_e_flag = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((rev_c_flag == <span class="number">1</span>)&amp;&amp;(rev_h_flag == <span class="number">1</span>)&amp;&amp;(rev_e_flag == <span class="number">1</span>)&amp;&amp;(rev_c2_flag == <span class="number">0</span>)&amp;&amp;(rev_k_flag == <span class="number">0</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Res == <span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				rev_c2_flag = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((rev_c_flag == <span class="number">1</span>)&amp;&amp;(rev_h_flag == <span class="number">1</span>)&amp;&amp;(rev_e_flag == <span class="number">1</span>)&amp;&amp;(rev_c2_flag == <span class="number">1</span>)&amp;&amp;(rev_k_flag == <span class="number">0</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(Res == <span class="string">&#x27;k&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				rev_c_flag = <span class="number">0</span>;</span><br><span class="line">				rev_h_flag = <span class="number">0</span>;</span><br><span class="line">				rev_e_flag = <span class="number">0</span>;</span><br><span class="line">				rev_c2_flag = <span class="number">0</span>;</span><br><span class="line">				rev_k_flag = <span class="number">0</span>;</span><br><span class="line">				send_flag = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">     &#125; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OS_TICKS_PER_SEC	 	<span class="comment">//如果时钟节拍数定义了,说明要使用ucosII了.</span></span></span><br><span class="line">	OSIntExit();  											 </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	</span></span><br></pre></td></tr></table></figure>

<h2 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h2><p><a target="_blank" rel="noopener" href="https://github.com/GiottoLee/SerialPort">Github</a></p>
</div><div class="tags"><a href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"><i class="fa fa-tag"></i>技术分享</a><a href="/tags/Qt/"><i class="fa fa-tag"></i>Qt</a><a href="/tags/%E4%B8%8A%E4%BD%8D%E6%9C%BA/"><i class="fa fa-tag"></i>上位机</a><a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"><i class="fa fa-tag"></i>嵌入式</a></div><div class="post-nav"><a class="pre" href="/2019/04/08/GitHelpDoc/">Git版本控制及远程仓库的使用</a><a class="next" href="/2019/01/01/2018Report/">我的2018年终总结</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/">年终总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/11/21/Dairy-2021-11-21/">随笔：我的朋友们</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/20/Dairy-2021-11-20/">随笔：如何判断自己是否走在“对的”路上</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/04/Dairy_2021_10_4/">随笔：再出发</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/02/2020Report/">我的2020年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/01/vuex_DOC/">状态管理模式 — Vuex如何使用？</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/01/LogMonitor/">用户行为日志监控数据可视化</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/07/K8s_client/">K8s 调用Java接口创建容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/06/Extract_2020_2_6/">摘阅：《在怀疑的时代依然需要信仰》</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/07/Springcloud_zipkin/">基于Spring Cloud搭建Zpikin数据链路追踪系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/02/2019Report/">我的2019年终总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/GiottoLee" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://www.zhihu.com/people/SilverBullet_SDU" title="知乎" target="_blank">知乎</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">SilverBullet.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>