<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="我答应了十八岁的自己不会变"><title>K8s 调用Java接口创建容器 | SilverBullet</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">K8s 调用Java接口创建容器</h1><a id="logo" href="/.">SilverBullet</a><p class="description">说些自己想说的话</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/tag/"><i class="fa fa-tags"> tag</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">K8s 调用Java接口创建容器</h1><div class="post-meta">2020-09-07<span> | </span><span class="category"><a href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.3k</span><span class="post-meta-item-text"> Words</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 6</span><span class="post-meta-item-text"> Minutes</span></span></span></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/"><strong>Kubernetes</strong></a>是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes的目标是让部署容器化的应用简单并且高效（powerful）, Kubernetes提供了应用部署，规划，更新，维护的一种机制。</p>
<p>控制台<code>kubectl</code>命令可以帮助我们操作K8s部署Deployment、pod、Service等，但当遇到批量部署的情况，以及实现自动化云端服务的时候，如何在后端调用接口则显得尤为重要。</p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>引入Maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.kubernetes<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>client-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.kubernetes<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>client-java-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h2><p><img src="/2020/09/07/K8s_client/image-20200907210934572.png" alt="image-20200907210934572"></p>
<p>根据官方更新日志，<code>9.0.0+</code> 版本以上更新了<code>GenericKubernetesApi</code>，但是经过我的使用发现，该接口在创建容器失败后，没有合适的对象封装异常，我们无法得知容器创建失败的原因，经过在github询问贡献者得知：</p>
<p><img src="/2020/09/07/K8s_client/image-20200907211507320.png" alt="image-20200907211507320"></p>
<p>根据现有版本的设计，需要使用<code>V1Status</code>接收返回的对象排查错误。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">      Call call = callBuilder.build();</span><br><span class="line">      call = tweakCallForCoreV1Group(call);</span><br><span class="line">      JsonElement element = apiClient.&lt;JsonElement&gt;execute(call, JsonElement.class).getData();</span><br><span class="line">      <span class="keyword">return</span> getKubernetesApiResponse(dataClass, element, apiClient.getJSON().getGson());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ApiException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.getCause() <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getCause()); <span class="comment">// make this a checked exception?</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> V1Status status;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        status = apiClient.getJSON().deserialize(e.getResponseBody(), V1Status.class);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (JsonSyntaxException jsonEx) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(jsonEx);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123; <span class="comment">// the response body can be something unexpected sometimes..</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> KubernetesApiResponse&lt;&gt;(status, e.getCode());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>以下出于使用方便考虑，依旧采用旧版本的接口调用K8s。</p>
<p>通过K8s接口创建容器大致分三步：</p>
<blockquote>
<pre><code>1. 创建与K8s api-server的连接；
 2. 构造容器接口；
 3. 构造容器对象；
 4. 调用容器接口创建容器。
</code></pre>
</blockquote>
<h3 id="创建Deployment"><a href="#创建Deployment" class="headerlink" title="创建Deployment"></a>创建Deployment</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">   ApiClient apiClient = <span class="keyword">new</span> ApiClient();</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置K8s ApiServer地址</span></span><br><span class="line">   apiClient.setBasePath(<span class="string">&quot;http://localhost:8080&quot;</span>);</span><br><span class="line">   Configuration.setDefaultApiClient(<span class="keyword">this</span>.apiClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置Deployment接口</span></span><br><span class="line">   <span class="keyword">private</span> AppsV1Api appsV1Api;</span><br><span class="line">   appsV1Api = <span class="keyword">new</span> AppsV1Api(<span class="keyword">this</span>.apiClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置标签</span></span><br><span class="line">   Map&lt;String, String&gt; matchLabels = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   matchLabels.put(<span class="string">&quot;app&quot;</span>, podName);</span><br><span class="line">   matchLabels.put(<span class="string">&quot;env&quot;</span>, env);</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置端口</span></span><br><span class="line">   List&lt;V1ContainerPort&gt; portList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   V1ContainerPort port = <span class="keyword">new</span> V1ContainerPort();</span><br><span class="line">   port.setName(<span class="string">&quot;httpd&quot;</span>);</span><br><span class="line">   port.setContainerPort(<span class="number">80</span>);</span><br><span class="line">   portList.add(port);</span><br><span class="line"></span><br><span class="line">   List&lt;V1EnvVar&gt; envs = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">   V1EnvVar clientIdEnv = <span class="keyword">new</span> V1EnvVar();</span><br><span class="line">   clientIdEnv.setName(<span class="string">&quot;client_id&quot;</span>);</span><br><span class="line">   clientIdEnv.setValue(clientId);</span><br><span class="line">   envs.add(clientIdEnv);</span><br><span class="line">   V1EnvVar clientSecretEnv = <span class="keyword">new</span> V1EnvVar();</span><br><span class="line">   clientSecretEnv.setName(<span class="string">&quot;client_secret&quot;</span>);</span><br><span class="line">   clientSecretEnv.setValue(clientSecret);</span><br><span class="line">   envs.add(clientSecretEnv);</span><br><span class="line">   V1EnvVar redirectEnv = <span class="keyword">new</span> V1EnvVar();</span><br><span class="line">   redirectEnv.setName(<span class="string">&quot;redirect_uri&quot;</span>);</span><br><span class="line">   redirectEnv.setValue(redirectUri);</span><br><span class="line">   envs.add(redirectEnv);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用对象封装Deployment</span></span><br><span class="line">   V1Deployment deploy =</span><br><span class="line">       <span class="keyword">new</span> V1DeploymentBuilder()</span><br><span class="line">           .withApiVersion(<span class="string">&quot;apps/v1&quot;</span>)</span><br><span class="line">           .withKind(<span class="string">&quot;Deployment&quot;</span>)</span><br><span class="line">           .withNewMetadata()</span><br><span class="line">           .withName(deploymentName)</span><br><span class="line">           .withNamespace(<span class="string">&quot;default&quot;</span>)</span><br><span class="line">           .endMetadata()</span><br><span class="line">           .withNewSpec()</span><br><span class="line">           .withReplicas(<span class="number">1</span>)</span><br><span class="line">           .withNewSelector()</span><br><span class="line">           .withMatchLabels(matchLabels)</span><br><span class="line">           .endSelector()</span><br><span class="line">           .withNewTemplate()</span><br><span class="line">           .withNewMetadata()</span><br><span class="line">           .withLabels(matchLabels)</span><br><span class="line">           .endMetadata()</span><br><span class="line">           .withNewSpec()</span><br><span class="line">           .withContainers(</span><br><span class="line">               <span class="keyword">new</span> V1Container()</span><br><span class="line">                   .name(podName)</span><br><span class="line">                   .image(<span class="string">&quot;cgwire&quot;</span>)</span><br><span class="line">                   .imagePullPolicy(<span class="string">&quot;Never&quot;</span>)</span><br><span class="line">                   .ports(portList)</span><br><span class="line">                   .env(envs))</span><br><span class="line">           .endSpec()</span><br><span class="line">           .endTemplate()</span><br><span class="line">           .endSpec().build();</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//调用容器接口创建Deployment</span></span><br><span class="line">               appsV1Api.createNamespacedDeployment(</span><br><span class="line">                   <span class="string">&quot;default&quot;</span>,	<span class="comment">//namespace</span></span><br><span class="line">                   deploy,		<span class="comment">//Deployment对象</span></span><br><span class="line">                   <span class="string">&quot;true&quot;</span>,		<span class="comment">//pretty</span></span><br><span class="line">                   <span class="keyword">null</span>,		<span class="comment">//dryRun</span></span><br><span class="line">                   <span class="keyword">null</span>);		<span class="comment">//fieldManager               </span></span><br><span class="line">         &#125; <span class="keyword">catch</span> (ApiException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> FastRuntimeException(BizCode.SERVICE_UNAVAILABLE.getCode(),e.getResponseBody());</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>



<h3 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a>创建Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">   ApiClient apiClient = <span class="keyword">new</span> ApiClient();</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置K8s ApiServer地址</span></span><br><span class="line">   apiClient.setBasePath(<span class="string">&quot;http://localhost:8080&quot;</span>);</span><br><span class="line">   Configuration.setDefaultApiClient(<span class="keyword">this</span>.apiClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置Service接口</span></span><br><span class="line">CoreV1Api coreV1Api = <span class="keyword">new</span> CoreV1Api(apiClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造Service对象</span></span><br><span class="line">	Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   map.put(<span class="string">&quot;app&quot;</span>, podName);</span><br><span class="line">   map.put(<span class="string">&quot;env&quot;</span>, env);</span><br><span class="line">   V1Service svc =</span><br><span class="line">       <span class="keyword">new</span> V1ServiceBuilder()</span><br><span class="line">           .withApiVersion(<span class="string">&quot;v1&quot;</span>)</span><br><span class="line">           .withKind(<span class="string">&quot;Service&quot;</span>)</span><br><span class="line">           .withNewMetadata()</span><br><span class="line">           .withName(serviceName)</span><br><span class="line">           .withNamespace(<span class="string">&quot;default&quot;</span>)</span><br><span class="line">           .endMetadata()</span><br><span class="line">           .withNewSpec()</span><br><span class="line">           .withSelector(map)</span><br><span class="line">           .addNewPort()</span><br><span class="line">           .withName(<span class="string">&quot;http&quot;</span>)</span><br><span class="line">           .withPort(<span class="number">80</span>)</span><br><span class="line">           .withTargetPort(<span class="keyword">new</span> IntOrString(<span class="number">80</span>))</span><br><span class="line">           .endPort()</span><br><span class="line">           .endSpec()</span><br><span class="line">           .build();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//调用接口操作K8s创建Service</span></span><br><span class="line">         coreV1Api.createNamespacedService(</span><br><span class="line">             svc.getMetadata().getNamespace(),	<span class="comment">//namespace</span></span><br><span class="line">             svc,								<span class="comment">//Service对象</span></span><br><span class="line">             <span class="string">&quot;true&quot;</span>,							<span class="comment">//pretty</span></span><br><span class="line">             <span class="keyword">null</span>,								<span class="comment">//dryRun</span></span><br><span class="line">             <span class="keyword">null</span>								<span class="comment">//fieldManager</span></span><br><span class="line">         );</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ApiException e) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> FastRuntimeException(BizCode.SERVICE_UNAVAILABLE.getCode(),e.getResponseBody());</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h3 id="创建Ingress"><a href="#创建Ingress" class="headerlink" title="创建Ingress"></a>创建Ingress</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">   ApiClient apiClient = <span class="keyword">new</span> ApiClient();</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置K8s ApiServer地址</span></span><br><span class="line">   apiClient.setBasePath(<span class="string">&quot;http://localhost:8080&quot;</span>);</span><br><span class="line">   Configuration.setDefaultApiClient(<span class="keyword">this</span>.apiClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置Ingress接口</span></span><br><span class="line">ExtensionV1beta1Api extensionsV1beta1Api = <span class="keyword">new</span> ExtensionsV1beta1Api(<span class="keyword">this</span>.apiClient);</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造Ingress对象</span></span><br><span class="line">Map&lt;String, String&gt; annotations = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   annotations.put(<span class="string">&quot;kubernetes.io/ingress.class&quot;</span>, <span class="string">&quot;nginx&quot;</span>);</span><br><span class="line"></span><br><span class="line">   List&lt;ExtensionsV1beta1HTTPIngressPath&gt; ingressPaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   ExtensionsV1beta1HTTPIngressPath path =</span><br><span class="line">       <span class="keyword">new</span> ExtensionsV1beta1HTTPIngressPath()</span><br><span class="line">           .path(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">           .backend(</span><br><span class="line">               <span class="keyword">new</span> ExtensionsV1beta1IngressBackend()</span><br><span class="line">                   .serviceName(serviceName)</span><br><span class="line">                   .servicePort(<span class="keyword">new</span> IntOrString(<span class="number">80</span>)));</span><br><span class="line">   ingressPaths.add(path);</span><br><span class="line"></span><br><span class="line">   ExtensionsV1beta1Ingress ingress =</span><br><span class="line">       <span class="keyword">new</span> ExtensionsV1beta1IngressBuilder()</span><br><span class="line">           .withApiVersion(<span class="string">&quot;extensions/v1beta1&quot;</span>)</span><br><span class="line">           .withKind(<span class="string">&quot;Ingress&quot;</span>)</span><br><span class="line">           .withNewMetadata()</span><br><span class="line">           .withName(<span class="string">&quot;ingress-&quot;</span> + subDomain)</span><br><span class="line">           .withNamespace(<span class="string">&quot;default&quot;</span>)</span><br><span class="line">           .withAnnotations(annotations)</span><br><span class="line">           .endMetadata()</span><br><span class="line">           .withNewSpec()</span><br><span class="line">           .withRules(</span><br><span class="line">               <span class="keyword">new</span> ExtensionsV1beta1IngressRule()</span><br><span class="line">                   .host(subDomain+<span class="string">&quot;.cgclass.net&quot;</span>)</span><br><span class="line">                   .http(</span><br><span class="line">                       <span class="keyword">new</span> ExtensionsV1beta1HTTPIngressRuleValue()</span><br><span class="line">                           .paths(ingressPaths)))</span><br><span class="line">           .endSpec()</span><br><span class="line">           .build();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//调用容器接口创建Ingress</span></span><br><span class="line">     	extensionsV1beta1Api.createNamespacedIngress(</span><br><span class="line">         ingress.getMetadata().getNamespace(),	<span class="comment">//namespace</span></span><br><span class="line">         ingress,								<span class="comment">//Ingress对象</span></span><br><span class="line">         <span class="string">&quot;true&quot;</span>,								<span class="comment">//pretty</span></span><br><span class="line">         <span class="keyword">null</span>,									<span class="comment">//dryRun</span></span><br><span class="line">         <span class="keyword">null</span>									<span class="comment">//fieldManager</span></span><br><span class="line">     );</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ApiException e) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> FastRuntimeException(BizCode.SERVICE_UNAVAILABLE.getCode(),e.getResponseBody());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>该版本的容器接口会抛出封装好的异常对象<code>ApiException</code>，通过捕获<code>ApiException</code>我们可以找到容器创建失败的原因：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  extensionsV1beta1Api.createNamespacedIngress(</span><br><span class="line">      ingress.getMetadata().getNamespace(),</span><br><span class="line">      ingress,</span><br><span class="line">      <span class="string">&quot;true&quot;</span>,</span><br><span class="line">      <span class="keyword">null</span>,</span><br><span class="line">      <span class="keyword">null</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (ApiException e) &#123;</span><br><span class="line">  System.out.println(e.getCause());</span><br><span class="line">  System.out.println(e.getMessage());</span><br><span class="line">  System.out.println(e.getResponseBody());</span><br><span class="line">  System.out.println(e.getStackTrace());</span><br><span class="line">  System.out.println(e.getCode());</span><br><span class="line">  System.out.println(e.getResponseHeaders());</span><br><span class="line">  System.out.println(e.getLocalizedMessage());</span><br><span class="line">  System.out.println(e.getSuppressed());</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> FastRuntimeException(BizCode.SERVICE_UNAVAILABLE.getCode(),e.getResponseBody());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>创建容器的流程看似复杂，但是思路十分清晰，先通过<code>ApiClient</code>创建与K8s的连接，然后初始化与该容器相匹配的容器接口，如<code>AppsV1Api</code> , <code>CoreV1Api</code> 或<code>ExtensionsV1beta1Api</code> ，将容器信息封装到对象<code>V1Deployment</code> , <code>V1Service</code> , <code>ExtensionsV1beta1Ingress</code> 中，最后调用容器接口创建容器并处理异常信息。</p>
<p><code>kubernetes-client/java</code> 目前网上教程内容较少并且质量堪忧（CSDN最近复制粘贴风气堪忧），只能借助于官方文档与实例，所以我将我的理解分享给大家，如有更好的解决方案，也欢迎大家与我交流。</p>
<p><strong>Talk is cheap, show me the code.</strong></p>
</div><div class="tags"><a href="/tags/技术分享"><i class="fa fa-tag">技术分享</i></a><a href="/tags/Kubernetes"><i class="fa fa-tag">Kubernetes</i></a></div><div class="post-nav"><a class="pre" href="/2020/10/01/LogMonitor/">用户行为日志监控数据可视化</a><a class="next" href="/2020/09/06/Extract_2020_2_6/">摘阅：《在怀疑的时代依然需要信仰》</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://giottolee.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/">年终总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://github.com/GiottoLee" title="Github" target="_blank">Github</a><ul></ul><a href="https://www.zhihu.com/people/SilverBullet_SDU" title="知乎" target="_blank">知乎</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">SilverBullet.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>